<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>花日历 — 小版 Demo</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#f7a8b8;
    --glass: rgba(255,255,255,0.03);
    --today-ring: rgba(255,160,160,0.18);
    font-family: Inter, "Helvetica Neue", Arial, sans-serif;
  }
  html,body{height:100%; margin:0; background:linear-gradient(180deg,#071022 0%, #071826 60%); color:#e6eef6;}
  .wrap{max-width:980px; margin:36px auto; padding:28px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; box-shadow:0 6px 30px rgba(3,7,18,0.6);}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  h1{margin:0; font-size:20px; letter-spacing:0.2px;}
  .controls{display:flex; gap:8px; align-items:center;}
  button{background:var(--glass); color:var(--muted); border:1px solid rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;}
  button:hover{color:#fff;}
  .calendar{margin-top:18px; display:grid; grid-template-rows:auto 1fr; gap:12px;}
  .month-head{display:flex; justify-content:space-between; align-items:center;}
  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px;}
  .weekday{color:var(--muted); text-align:center; font-size:12px; padding:6px 0;}
  .day{
    min-height:88px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    border-radius:10px; padding:8px; position:relative; cursor:pointer; overflow:hidden;
    border:1px solid rgba(255,255,255,0.02);
  }
  .day.inactive{opacity:0.28;}
  .date-num{font-size:13px; font-weight:700; color:#dbe9ff;}
  .flowers-wrap{position:absolute; inset:34px 6px 6px 6px; display:flex; gap:6px; flex-wrap:wrap; align-items:flex-end;}
  .flower-icon{width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 4px 18px rgba(2,6,12,0.5); overflow:hidden;}
  .today{box-shadow:0 0 0 3px var(--today-ring) inset, 0 10px 30px rgba(0,0,0,0.6);}
  footer{margin-top:18px; color:var(--muted); font-size:13px; display:flex; justify-content:space-between;}
  /* modal */
  .modal{position:fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,12,0.6);}
  .modal.open{display:flex;}
  .panel{width:420px; max-width:94%; background:linear-gradient(180deg,#071425,#0e1b2a); border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(0,0,0,0.6);}
  .panel h3{margin:0 0 8px 0;}
  .flower-preview{display:flex; justify-content:center; padding:12px 0;}
  .row{display:flex; gap:8px; align-items:center; margin-top:8px;}
  .muted{color:var(--muted); font-size:13px;}
  .btn-primary{background:linear-gradient(90deg,#ff8aa2,#ffd1a9); color:#08111b; border:none; padding:10px 14px; border-radius:10px; font-weight:700;}
  .btn-ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04);}
  .mini{font-size:12px; padding:6px 8px;}
  /* small */
  .tag{font-size:12px; color:var(--muted);}
  .empty{opacity:0.35; font-size:13px; text-align:center; padding:12px;}
</style>
</head>
<body>
  <div class="wrap" role="application" aria-label="花日历应用">
    <header>
      <div>
        <h1>花日历</h1>
        <div class="tag">点击“今天”会生成一朵随机小花并保存到你的本地日历</div>
      </div>
      <div class="controls">
        <button id="todayBtn">今天</button>
        <button id="prevMonth">&lt;</button>
        <div id="monthLabel" style="min-width:160px; text-align:center; font-weight:700;"></div>
        <button id="nextMonth">&gt;</button>
      </div>
    </header>

    <section class="calendar" id="calendar">
      <div class="month-head"></div>
      <div>
        <div class="grid" id="weekdayRow"></div>
        <div class="grid" id="daysGrid" style="margin-top:8px;"></div>
      </div>
    </section>

    <footer>
      <div class="muted">数据保存在浏览器（localStorage）——每个用户都是私有的</div>
      <div class="muted">可部署到 GitHub Pages（静态）</div>
    </footer>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="panel" role="document">
      <h3 id="modalTitle">日期</h3>
      <div class="flower-preview" id="flowerPreview"></div>
      <div class="row">
        <div class="muted">花名（可选）</div>
        <input id="flowerName" style="flex:1; padding:8px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted);" placeholder="给你的花起个名字（可不填）" />
      </div>
      <div class="row" style="justify-content:flex-end;">
        <button id="regen" class="btn-ghost mini">重新生成</button>
        <button id="saveFlower" class="btn-primary mini" style="margin-left:8px;">保存到此日</button>
        <button id="closeModal" class="btn-ghost mini" style="margin-left:8px;">关闭</button>
      </div>
      <div id="modalNote" class="muted" style="margin-top:8px;">提示：点击今天按钮会自动生成并保存。</div>
    </div>
  </div>

<script>
/* ========== Utilities ========== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const WEEKDAYS = ['周日','周一','周二','周三','周四','周五','周六'];

function pad(n){ return n<10 ? '0'+n : ''+n; }
function ymKey(year,month){ return `flowers:${year}:${pad(month)}`; } // month 01-12

/* ========== Flower generator (procedural SVG) ========== */
function rand(seed){ // simple pseudo-random with seed optional
  let x = seed ? (Math.abs(Math.sin(seed))*10000) : Math.random();
  return () => {
    x = (x * 9301 + 49297) % 233280;
    return x / 233280;
  };
}

function randomColor(rng){
  // pastel-ish palette
  const hue = Math.floor(rng()*360);
  const sat = 50 + Math.floor(rng()*30);
  const light = 55 + Math.floor(rng()*20);
  return `hsl(${hue} ${sat}% ${light}%)`;
}

function makeFlowerSVG(opts = {}) {
  // opts: seed (number), petals (int), petalShape(0..2), size
  const seed = opts.seed ?? Math.floor(Math.random()*1e9);
  const rng = rand(seed);
  const petals = opts.petals ?? (5 + Math.floor(rng()*6)); // 5-10
  const shape = opts.petalShape ?? Math.floor(rng()*3);
  const size = opts.size ?? 72;
  const centerColor = randomColor(rng);
  const petalColor = randomColor(rng);
  const petalOpacity = 0.9 - rng()*0.25;
  const rotationJitter = (rng()*12 - 6);

  // create SVG string
  const cx = size/2, cy = size/2;
  let petalsSvg = '';
  for(let i=0;i<petals;i++){
    const angle = (360/petals)*i + rotationJitter*(rng()-0.5);
    const scale = 0.8 + rng()*0.6;
    let path;
    if(shape===0){
      // rounded petal (ellipse-ish)
      path = `<ellipse cx="${cx}" cy="${cy - size*0.24}" rx="${size*0.14*scale}" ry="${size*0.34*scale}" />`;
    } else if(shape===1){
      // teardrop path
      path = `<path d="M${cx} ${cy - size*0.22} C ${cx + size*0.22*scale} ${cy - size*0.10} ${cx + size*0.14*scale} ${cy + size*0.22} ${cx} ${cy + size*0.28} C ${cx - size*0.14*scale} ${cy + size*0.22} ${cx - size*0.22*scale} ${cy - size*0.10} ${cx} ${cy - size*0.22} Z" />`;
    } else {
      // leaf-like
      path = `<path d="M${cx} ${cy - size*0.20} Q ${cx + size*0.26*scale} ${cy - size*0.02} ${cx + size*0.06*scale} ${cy + size*0.28} Q ${cx - size*0.06*scale} ${cy + size*0.28} ${cx - size*0.06*scale} ${cy - size*0.02} Q ${cx - size*0.26*scale} ${cy - size*0.02} ${cx} ${cy - size*0.20} Z" />`;
    }
    petalsSvg += `<g transform="rotate(${angle} ${cx} ${cy})" style="transform-origin:${cx}px ${cy}px;">
        ${path}
      </g>`;
  }

  const svg = `<svg viewBox="0 0 ${size} ${size}" width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="小花图">
    <defs>
      <filter id="f${seed}" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur stdDeviation="2" result="b"/>
        <feBlend in="SourceGraphic" in2="b" mode="normal"/>
      </filter>
    </defs>
    <g fill="${petalColor}" fill-opacity="${petalOpacity}" stroke="none" filter="url(#f${seed})">
      ${petalsSvg}
    </g>
    <circle cx="${cx}" cy="${cy}" r="${size*0.12}" fill="${centerColor}" />
    <style>
      svg { display:block; }
      /* subtle pop animation */
      .pop{ transform-origin:${cx}px ${cy}px; animation:pop 560ms cubic-bezier(.2,.9,.3,1); }
      @keyframes pop { 0%{ transform:scale(.6) } 60%{ transform:scale(1.08)} 100%{ transform:scale(1) } }
    </style>
  </svg>`;

  return { svg, meta: { seed, petals, shape, petalColor, centerColor } };
}

/* ========== Storage API (per-browser, per-user) ========== */
function loadMonthData(year, month){
  const key = ymKey(year, month);
  const raw = localStorage.getItem(key);
  if(!raw) return {}; // map day -> array of flowers
  try { return JSON.parse(raw); } catch(e){ return {}; }
}
function saveMonthData(year,month,data){
  const key = ymKey(year, month);
  localStorage.setItem(key, JSON.stringify(data));
}

/* ========== Calendar UI ========== */
const weekdayRow = qs('#weekdayRow');
const daysGrid = qs('#daysGrid');
const monthLabel = qs('#monthLabel');
const prevBtn = qs('#prevMonth'), nextBtn = qs('#nextMonth'), todayBtn = qs('#todayBtn');

let viewDate = new Date(); // shows month of this date
const today = new Date();
let modalOpenedFor = null; // {y,m,d}

function renderWeekdays(){
  weekdayRow.innerHTML = '';
  for(let i=0;i<7;i++){
    const w = document.createElement('div');
    w.className = 'weekday';
    w.textContent = WEEKDAYS[i];
    weekdayRow.appendChild(w);
  }
}

function renderCalendar(){
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth()+1; // 1-12
  monthLabel.textContent = `${year} 年 ${month} 月`;
  daysGrid.innerHTML = '';

  const firstOfMonth = new Date(year, viewDate.getMonth(), 1);
  const startWeek = firstOfMonth.getDay(); // 0-6
  const daysInMonth = new Date(year, viewDate.getMonth()+1, 0).getDate();

  // previous month filler
  const prevMonthLastDay = new Date(year, viewDate.getMonth(), 0).getDate();
  for(let i=0;i<startWeek;i++){
    const d = prevMonthLastDay - (startWeek - 1 - i);
    const cell = document.createElement('div'); cell.className='day inactive';
    cell.innerHTML = `<div class="date-num">${d}</div>`;
    daysGrid.appendChild(cell);
  }

  const monthData = loadMonthData(year, pad(month));
  for(let day=1; day<=daysInMonth; day++){
    const cell = document.createElement('div'); cell.className='day';
    const isToday = (year===today.getFullYear() && month===today.getMonth()+1 && day===today.getDate());
    if(isToday) cell.classList.add('today');

    // header
    const header = document.createElement('div'); header.className='date-num';
    header.textContent = day;
    cell.appendChild(header);

    // flower thumbs
    const fw = document.createElement('div'); fw.className='flowers-wrap';
    const arr = monthData[day] || [];
    if(arr.length===0){
      // leave empty
    } else {
      arr.slice(0,6).forEach((f,idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'flower-icon';
        wrap.title = f.name || `flower #${idx+1}`;
        wrap.innerHTML = f.svg;
        fw.appendChild(wrap);
      });
    }
    cell.appendChild(fw);

    // click handler
    cell.addEventListener('click', (ev)=>{
      openModalFor(year, month, day);
    });

    daysGrid.appendChild(cell);
  }

  // trailing filler to complete 7xN grid
  const totalCells = startWeek + daysInMonth;
  const trailing = (7 - (totalCells % 7)) % 7;
  for(let i=0;i<trailing;i++){
    const cell = document.createElement('div'); cell.className='day inactive';
    const d = i+1;
    cell.innerHTML = `<div class="date-num">${d}</div>`;
    daysGrid.appendChild(cell);
  }
}

/* ========== Modal & actions ========== */
const modal = qs('#modal'), modalTitle = qs('#modalTitle'), flowerPreview = qs('#flowerPreview');
const flowerNameInput = qs('#flowerName'), regenBtn = qs('#regen'), saveBtn = qs('#saveFlower'), closeBtn = qs('#closeModal');

let currentPreview = null;

function openModalFor(year, month, day, autoGenerate=false){
  modalOpenedFor = {year, month, day};
  modalTitle.textContent = `${year}-${pad(month)}-${pad(day)}`;
  flowerNameInput.value = '';
  // load existing flowers for this day
  const monthData = loadMonthData(year, pad(month));
  const arr = monthData[day] || [];
  if(arr.length>0 && !autoGenerate){
    // show last one as preview
    const last = arr[arr.length-1];
    renderPreview(last.svg);
  } else {
    // generate new
    generateAndPreview();
    if(autoGenerate){
      // auto save immediately
      saveCurrentlyPreviewed();
    }
  }
  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
}

function closeModal(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
  modalOpenedFor = null;
}

function renderPreview(svgHtml){
  flowerPreview.innerHTML = `<div class="pop" style="width:140px;height:140px;">${svgHtml}</div>`;
}

function generateAndPreview(){
  const f = makeFlowerSVG({ size:120 });
  currentPreview = f;
  renderPreview(f.svg);
  flowerNameInput.value = '';
}

function saveCurrentlyPreviewed(){
  if(!modalOpenedFor || !currentPreview) return;
  const {year,month,day} = modalOpenedFor;
  const y = year, m = pad(month);
  const monthData = loadMonthData(y, m);
  if(!monthData[day]) monthData[day] = [];
  const name = (flowerNameInput.value || '').trim();
  // store minimal necessary info (svg + meta + name)
  monthData[day].push({ svg: currentPreview.svg, meta: currentPreview.meta, name });
  saveMonthData(y, m, monthData);
  closeModal();
  renderCalendar();
}

/* ========== Wiring ========== */
renderWeekdays();
renderCalendar();

prevBtn.addEventListener('click', ()=>{
  viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()-1, 1);
  renderCalendar();
});
nextBtn.addEventListener('click', ()=>{
  viewDate = new Date(viewDate.getFullYear(), viewDate.getMonth()+1, 1);
  renderCalendar();
});
todayBtn.addEventListener('click', ()=>{
  // navigate to current month, then open modal for today with auto-generate+save
  viewDate = new Date(today.getFullYear(), today.getMonth(), 1);
  renderCalendar();
  // small timeout to ensure DOM rendered
  setTimeout(()=> {
    openModalFor(today.getFullYear(), today.getMonth()+1, today.getDate(), true);
  }, 60);
});

regenBtn.addEventListener('click', ()=>{
  generateAndPreview();
});
saveBtn.addEventListener('click', ()=>{
  saveCurrentlyPreviewed();
});
closeBtn.addEventListener('click', ()=>{
  closeModal();
});

// also close modal when clicking outside panel
modal.addEventListener('click', (e)=>{
  if(e.target === modal) closeModal();
});

/* ========== init: if user directly clicks today's cell also should trigger auto generation === */
(function attachTodayClickAuto(){
  // replace renderCalendar's today cell click: already opens modal; but we want: if clicked for today, auto generate and save.
  // We'll override existing cell click each render by listening at document level and comparing target day element.
  daysGrid.addEventListener('click', (e)=>{
    const el = e.target.closest('.day');
    if(!el) return;
    const txt = el.querySelector('.date-num')?.textContent;
    if(!txt) return;
    const dayNum = parseInt(txt,10);
    const year = viewDate.getFullYear(), month = viewDate.getMonth()+1;
    if(year===today.getFullYear() && month===today.getMonth()+1 && dayNum===today.getDate()){
      // open modal and auto-generate+save
      openModalFor(year, month, dayNum, true);
    } else {
      // open normally (handled already by cell click) — nothing extra
    }
  });
})();
</script>
</body>
</html>